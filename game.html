<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSplit | Quiz Arena Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- DESIGN SYSTEM (PƒÉstrat + Extins) --- */
        :root {
            --bg-body: #09090b;
            --bg-gradient-1: rgba(167, 139, 250, 0.15);
            --bg-gradient-2: rgba(45, 212, 191, 0.15);
            --panel-bg: rgba(24, 24, 27, 0.75);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --text-accent: #a78bfa;
            --text-secondary: #2dd4bf;
            --text-error: #fb7185;
            --btn-bg: linear-gradient(135deg, #8b5cf6, #6366f1);
            --btn-hover: linear-gradient(135deg, #7c3aed, #4f46e5);
        }

        body.light-mode {
            --bg-body: #f8fafc;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-border: rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; transition: 0.3s; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 10% 20%, var(--bg-gradient-1) 0%, transparent 50%), radial-gradient(circle at 90% 80%, var(--bg-gradient-2) 0%, transparent 50%);
            background-attachment: fixed; color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- AUTH STYLES --- */
        .auth-card { max-width: 400px; width: 100%; margin-top: 100px; padding: 30px; border-radius: 20px; background: var(--panel-bg); border: 1px solid var(--panel-border); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(0,0,0,0.2); color: white; }
        .auth-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--btn-bg); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* --- APP STYLES --- */
        .container { width: 100%; max-width: 800px; }
        .panel { background: var(--panel-bg); backdrop-filter: blur(20px); border: 1px solid var(--panel-border); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .action-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--btn-bg); color: white; font-weight: bold; cursor: pointer; }
        
        .history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid var(--panel-border); 
        }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        .upload-area { border: 2px dashed var(--panel-border); border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; }

        .header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .btn-option { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--panel-border); 
            color: var(--text-main); padding: 16px; border-radius: 12px; cursor: pointer; text-align: left; width: 100%; margin-bottom: 10px;
        }
        .btn-option.correct { border-color: var(--text-secondary); background: rgba(45, 212, 191, 0.15) !important; }
        .btn-option.wrong { border-color: var(--text-error); background: rgba(251, 113, 133, 0.15) !important; }
        .btn-option.selected { border-color: var(--text-accent); background: rgba(167, 139, 250, 0.1); }
    </style>
</head>
<body>

    <!-- ECRAN LOGARE -->
    <div id="auth-screen" class="auth-card">
        <h1 style="background: linear-gradient(to right, var(--text-accent), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NeuroSplit</h1>
        <p style="color: var(--text-muted);">ConecteazƒÉ-te pentru a salva progresul</p>
        <input type="email" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="ParolƒÉ">
        <button class="auth-btn" onclick="handleAuth('login')">Conectare</button>
        <button class="auth-btn" style="background:none; border:1px solid var(--text-accent); margin-top:10px;" onclick="handleAuth('signup')">CreeazƒÉ Cont</button>
        <p id="auth-msg" style="font-size: 0.8rem; margin-top: 10px; color: var(--text-error);"></p>
    </div>

    <!-- ECRAN APP -->
    <div id="app-screen" class="container hidden">
        <div class="header">
            <h2 id="user-display" style="font-size: 1.2rem; color: var(--text-secondary);">...</h2>
            <div style="display:flex; gap:10px;">
                <button class="auth-btn" style="padding: 5px 15px; font-size: 0.8rem;" onclick="handleLogout()">Logout</button>
                <button class="auth-btn" style="padding: 5px 15px; font-size: 0.8rem; background: var(--text-muted);" onclick="toggleTheme()">üåì</button>
            </div>
        </div>

        <!-- START SCREEN -->
        <div id="start-screen">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="panel">
                    <h3 style="margin:0 0 15px 0; color: var(--text-accent);">üë§ Profil</h3>
                    <div id="profile-info">
                        <div class="stat-row"><span>Nume:</span> <b id="user-name">...</b></div>
                        <div class="stat-row"><span>Nivel:</span> <b id="lvl-start" style="color:var(--text-accent)">1</b></div>
                        <div class="stat-row"><span>XP:</span> <b id="xp-start">0</b></div>
                        <button class="auth-btn" style="font-size: 0.7rem; margin-top: 10px; padding: 5px;" onclick="showEditName()">EditeazƒÉ Nume</button>
                    </div>
                    <div id="profile-edit" class="hidden">
                        <input type="text" id="new-name" class="auth-input" placeholder="Nume nou">
                        <button class="auth-btn" onclick="saveName()">SalveazƒÉ</button>
                    </div>
                </div>

                <div class="panel">
                    <h3 style="margin:0 0 15px 0; color: var(--text-secondary);">üöÄ √éncarcƒÉ Grile</h3>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem;">üìÇ</div>
                        <p style="font-size: 0.8rem; color: var(--text-muted);">Format .txt</p>
                        <input type="file" id="fileInput" accept=".txt" style="display: none" onchange="uploadQuiz(this)">
                    </div>
                </div>
            </div>

            <div class="panel" id="history-panel">
                <h3 style="margin:0 0 15px 0; font-size: 0.9rem; color: var(--text-muted);">üìö GRILELE TALE (Cloud)</h3>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.8rem;">
                    <span id="q-type">Single Choice</span>
                    <span id="q-counter">1 / 10</span>
                </div>
                <div id="question-text" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;">...</div>
                <div id="options-container"></div>
                <button id="validate-btn" class="action-btn hidden" onclick="submitMultiAnswer()">ValideazƒÉ</button>
                <div id="explanation-container" class="hidden" style="margin-top: 20px; padding: 15px; border-left: 4px solid var(--text-secondary); background: rgba(45,212,191,0.05);">
                    <div id="explanation-text"></div>
                </div>
                <div style="display:flex; gap: 10px; margin-top: 20px;">
                    <button class="auth-btn" style="background:rgba(255,255,255,0.1)" onclick="navigate(-1)">‚¨Ö √énapoi</button>
                    <button class="auth-btn" onclick="navigate(1)">√énainte ‚û°</button>
                </div>
            </div>
        </div>

        <!-- REVIEW SCREEN -->
        <div id="review-screen" class="hidden">
            <div class="panel" style="text-align: center;">
                <h2>üéâ Gata!</h2>
                <p>Progresul a fost sincronizat √Æn cloud.</p>
                <button class="action-btn" onclick="goHome()">Meniu Principal</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURARE SUPABASE ---
        const SB_URL = "https://xfmtqlhvqjdsynoonkoo.supabase.co"; // Pune URL-ul tau
        const SB_KEY = "sb_publishable_yOAvTROODK4KdkY_abuhEw_bcT2m5Tl"; // Pune cheia ta
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let gameState = { questions: [], currentIndex: 0, streak: 0, xp: 0, level: 1, userHistory: {}, mistakes: [] };
        let cloudFiles = [];

        // --- AUTH ---
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('auth-msg');

            msg.innerText = "Se proceseazƒÉ...";
            const { data, error } = (type === 'login') 
                ? await _supabase.auth.signInWithPassword({ email, password })
                : await _supabase.auth.signUp({ email, password });

            if (error) msg.innerText = error.message;
            else if (type === 'signup') msg.innerText = "VerificƒÉ email-ul pentru confirmare!";
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initAppData();
            }
        });

        // --- DATA FLOW ---
        async function initAppData() {
            // Incarca profil
            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (profile) {
                gameState.xp = profile.xp;
                gameState.level = profile.level;
                document.getElementById('user-name').innerText = profile.username || "Elev Nou";
                document.getElementById('user-display').innerText = "Salut, " + (profile.username || currentUser.email);
                updateProfileUI();
            } else {
                // Creeaza profil nou
                const userEmail = currentUser.email.split('@')[0];
                await _supabase.from('profiles').insert([{ id: currentUser.id, username: userEmail }]);
                initAppData();
            }
            loadQuizzes();
        }

        async function loadQuizzes() {
            const { data } = await _supabase.from('quizzes').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            cloudFiles = data || [];
            renderHistory();
        }

        // --- PROFILE FUNCTIONS ---
        function showEditName() {
            document.getElementById('profile-info').classList.add('hidden');
            document.getElementById('profile-edit').classList.remove('hidden');
        }

        async function saveName() {
            const newName = document.getElementById('new-name').value;
            if (!newName) return;
            await _supabase.from('profiles').update({ username: newName }).eq('id', currentUser.id);
            document.getElementById('profile-info').classList.remove('hidden');
            document.getElementById('profile-edit').classList.add('hidden');
            initAppData();
        }

        // --- QUIZ MANAGEMENT ---
        async function uploadQuiz(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                const name = file.name.replace('.txt', '');
                await _supabase.from('quizzes').insert([{ user_id: currentUser.id, name, content }]);
                loadQuizzes();
            };
            reader.readAsText(file);
        }

        async function deleteQuiz(id) {
            if (confirm("»òtergi definitiv aceastƒÉ grilƒÉ?")) {
                await _supabase.from('quizzes').delete().eq('id', id);
                loadQuizzes();
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            cloudFiles.forEach(q => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span><b>${q.name}</b> <small>(Jucat: ${q.plays})</small></span>
                    <div>
                        <button class="replay-btn" onclick="launchGame('${q.id}')">‚ñ∂ JoacƒÉ</button>
                        <button class="btn-icon" onclick="deleteQuiz('${q.id}')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- GAME ENGINE ---
        function launchGame(id) {
            const quiz = cloudFiles.find(f => f.id === id);
            parseQuestions(quiz.content);
            gameState.currentIndex = 0;
            gameState.userHistory = {};
            
            _supabase.from('quizzes').update({ plays: quiz.plays + 1 }).eq('id', id);
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderQuestion();
        }

        function parseQuestions(text) {
            const blocks = text.split('---');
            gameState.questions = [];
            blocks.forEach(b => {
                const lines = b.trim().split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 3) return;
                let obj = { text: '', options: {}, correct: [], explanation: '' };
                lines.forEach(l => {
                    if (l.startsWith('Q:')) obj.text = l.substring(2).trim();
                    else if (l.match(/^[A-Z]:/)) obj.options[l[0]] = l.substring(2).trim();
                    else if (l.startsWith('CORRECT:')) obj.correct = l.substring(8).split(',').map(s => s.trim().toUpperCase());
                    else if (l.startsWith('EXPLICATIE:')) obj.explanation = l.substring(11).trim();
                });
                gameState.questions.push(obj);
            });
            gameState.questions.sort(() => Math.random() - 0.5);
        }

        function renderQuestion() {
            const q = gameState.questions[gameState.currentIndex];
            const history = gameState.userHistory[gameState.currentIndex] || { answered: false, selected: [] };
            
            document.getElementById('q-counter').innerText = `${gameState.currentIndex + 1} / ${gameState.questions.length}`;
            document.getElementById('question-text').innerText = q.text;
            document.getElementById('explanation-container').classList.add('hidden');
            document.getElementById('validate-btn').classList.add('hidden');
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            const isMulti = q.correct.length > 1;
            document.getElementById('q-type').innerText = isMulti ? "Multi Choice" : "Single Choice";

            Object.entries(q.options).forEach(([key, val]) => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerHTML = `<b>${key})</b> ${val}`;
                
                if (history.answered) {
                    if (q.correct.includes(key)) btn.classList.add('correct');
                    if (history.selected.includes(key) && !q.correct.includes(key)) btn.classList.add('wrong');
                    btn.disabled = true;
                } else {
                    btn.onclick = () => isMulti ? toggleMulti(key, btn) : checkSingle(key);
                    if (history.selected.includes(key)) btn.classList.add('selected');
                }
                container.appendChild(btn);
            });

            if (!history.answered && isMulti) document.getElementById('validate-btn').classList.remove('hidden');
            if (history.answered) {
                document.getElementById('explanation-text').innerText = q.explanation || "FƒÉrƒÉ explica»õie.";
                document.getElementById('explanation-container').classList.remove('hidden');
            }
        }

        function checkSingle(key) {
            const q = gameState.questions[gameState.currentIndex];
            const isCorrect = q.correct.includes(key);
            finalize(isCorrect, [key]);
        }

        function toggleMulti(key, btn) {
            let h = gameState.userHistory[gameState.currentIndex] || { answered: false, selected: [] };
            if (h.selected.includes(key)) h.selected = h.selected.filter(k => k !== key);
            else h.selected.push(key);
            gameState.userHistory[gameState.currentIndex] = h;
            renderQuestion();
        }

        function submitMultiAnswer() {
            const h = gameState.userHistory[gameState.currentIndex];
            const q = gameState.questions[gameState.currentIndex];
            const isCorrect = h.selected.sort().join(',') === q.correct.sort().join(',');
            finalize(isCorrect, h.selected);
        }

        async function finalize(isCorrect, selected) {
            gameState.userHistory[gameState.currentIndex] = { answered: true, selected };
            if (isCorrect) {
                gameState.xp += 15;
                if (gameState.xp >= gameState.level * 100) gameState.level++;
                confetti({ particleCount: 50, spread: 60 });
            }
            await _supabase.from('profiles').update({ xp: gameState.xp, level: gameState.level }).eq('id', currentUser.id);
            updateProfileUI();
            renderQuestion();
        }

        function navigate(dir) {
            const next = gameState.currentIndex + dir;
            if (next >= 0 && next < gameState.questions.length) {
                gameState.currentIndex = next;
                renderQuestion();
            } else if (next >= gameState.questions.length) {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('review-screen').classList.remove('hidden');
            }
        }

        function goHome() {
            document.getElementById('review-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            initAppData();
        }

        function updateProfileUI() {
            document.getElementById('lvl-start').innerText = gameState.level;
            document.getElementById('xp-start').innerText = gameState.xp;
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }
    </script>
</body>
</html>
