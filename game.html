<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSplit | Auth & Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* CSS-ul anterior rÄƒmÃ¢ne neschimbat, adÄƒugÄƒm doar cÃ¢teva clase noi pentru Auth */
        :root {
            --bg-body: #09090b;
            --panel-bg: rgba(24, 24, 27, 0.85);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-main: #f4f4f5;
            --text-accent: #a78bfa;
            --text-secondary: #2dd4bf;
            --text-error: #fb7185;
        }

        /* [PÄƒstreazÄƒ tot stilul tÄƒu anterior aici...] */
        /* AdÄƒugÄƒri pentru InterfaÈ›a NouÄƒ: */
        .auth-container { max-width: 400px; margin: 100px auto; padding: 30px; border-radius: 20px; background: var(--panel-bg); border: 1px solid var(--panel-border); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(255,255,255,0.05); color: white; }
        .nav-header { display: flex; justify-content: space-between; width: 100%; max-width: 800px; margin-bottom: 20px; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; border: 1px solid var(--panel-border); background: transparent; color: var(--text-muted); }
        .btn-delete { color: var(--text-error); border-color: var(--text-error); margin-left: 10px; }
        .btn-delete:hover { background: var(--text-error); color: white; }
        
        /* [CopiazÄƒ aici restul stilurilor tale din versiunea anterioarÄƒ] */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 20px; padding: 25px; margin-bottom: 20px; width: 100%; }
        .hidden { display: none !important; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .upload-area { border: 2px dashed var(--panel-border); padding: 30px; text-align: center; cursor: pointer; border-radius: 15px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--panel-border); }
        .action-btn { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; }
    </style>
</head>
<body>

    <!-- ECRAN AUTENTIFICARE -->
    <div id="auth-screen" class="auth-container">
        <h1 style="color: var(--text-accent);">NeuroSplit</h1>
        <p style="color: var(--text-muted);">IntrÄƒ Ã®n Arena Grilelor</p>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email">
        <input type="password" id="auth-password" class="auth-input" placeholder="ParolÄƒ">
        <button class="action-btn" onclick="handleAuth('login')">Conectare</button>
        <p style="margin: 15px 0; font-size: 0.8rem;">sau</p>
        <button class="btn-small" onclick="handleAuth('signup')">CreeazÄƒ Cont Nou</button>
        <p id="auth-error" style="color: var(--text-error); font-size: 0.8rem; margin-top: 10px;"></p>
    </div>

    <!-- ECRAN PRINCIPAL -->
    <div id="main-app" class="hidden" style="width: 100%; max-width: 800px;">
        <div class="nav-header">
            <span style="color: var(--text-muted);">Bun venit, <b id="display-username" style="color: var(--text-secondary);">...</b></span>
            <button class="btn-small" onclick="handleLogout()">IeÈ™ire (Logout)</button>
        </div>

        <div id="start-screen">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="panel">
                    <h3 style="color: var(--text-accent); margin-top:0;">ğŸ‘¤ Profil</h3>
                    <div id="profile-view">
                        <div class="stat-row"><span>Nume:</span> <b id="user-name-label">...</b></div>
                        <div class="stat-row"><span>Nivel:</span> <b id="lvl-start">1</b></div>
                        <div class="stat-row"><span>XP:</span> <b id="xp-start">0</b></div>
                        <button class="btn-small" onclick="toggleEditProfile(true)" style="margin-top:10px;">EditeazÄƒ Nume</button>
                    </div>
                    <div id="profile-edit" class="hidden">
                        <input type="text" id="edit-username-input" class="auth-input" placeholder="Nume nou">
                        <div style="display:flex; gap:10px;">
                            <button class="btn-small" onclick="saveNewUsername()">SalveazÄƒ</button>
                            <button class="btn-small" onclick="toggleEditProfile(false)">AnuleazÄƒ</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3 style="color: var(--text-secondary); margin-top:0;">ğŸš€ ÃncarcÄƒ Grile</h3>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 1.5rem;">ğŸ“‚</div>
                        <p style="font-size: 0.8rem; margin: 5px 0;">Click pentru .txt</p>
                        <input type="file" id="fileInput" accept=".txt" style="display: none" onchange="handleFileUpload(this)">
                    </div>
                </div>
            </div>

            <div class="panel" id="history-panel" style="display:none; margin-top:20px;">
                <h3 style="color: var(--text-muted); font-size: 0.8rem;">ISTORIC GRILE</h3>
                <div id="history-list"></div>
            </div>
        </div>
        
        <!-- [Aici rÄƒmÃ¢ne restul structurii tale pentru game-screen È™i review-screen din versiunea anterioarÄƒ] -->
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://XYZ.supabase.co'; // AdaugÄƒ URL-ul tÄƒu
        const SUPABASE_KEY = 'CHEIA_ANON_PUBLICA';      // AdaugÄƒ Cheia ta
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let cloudFiles = [];

        // --- AUTH LOGIC ---
        async function handleAuth(type) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');

            const { data, error } = (type === 'signup') 
                ? await _supabase.auth.signUp({ email, password })
                : await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                errorEl.innerText = error.message;
            } else {
                checkUser();
            }
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                await loadUserProfile();
                await loadCloudQuizzes();
            }
        }

        _supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') checkUser();
        });

        // --- PROFILE LOGIC ---
        async function loadUserProfile() {
            const { data, error } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                document.getElementById('user-name-label').innerText = data.username || "FÄƒrÄƒ nume";
                document.getElementById('display-username').innerText = data.username || currentUser.email;
                document.getElementById('lvl-start').innerText = data.level;
                document.getElementById('xp-start').innerText = data.xp;
            } else {
                // DacÄƒ e cont nou, creÄƒm profilul implicit
                const defaultName = currentUser.email.split('@')[0];
                await _supabase.from('profiles').insert([{ id: currentUser.id, username: defaultName, xp: 0, level: 1 }]);
                loadUserProfile();
            }
        }

        function toggleEditProfile(show) {
            document.getElementById('profile-view').classList.toggle('hidden', show);
            document.getElementById('profile-edit').classList.toggle('hidden', !show);
        }

        async function saveNewUsername() {
            const newName = document.getElementById('edit-username-input').value;
            if (!newName) return;
            const { error } = await _supabase.from('profiles').update({ username: newName }).eq('id', currentUser.id);
            if (!error) {
                toggleEditProfile(false);
                loadUserProfile();
            }
        }

        // --- QUIZ LOGIC (Delete & Load) ---
        async function loadCloudQuizzes() {
            const { data } = await _supabase.from('quizzes').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            cloudFiles = data || [];
            renderHistory();
        }

        function renderHistory() {
            const panel = document.getElementById('history-panel');
            const list = document.getElementById('history-list');
            panel.style.display = cloudFiles.length > 0 ? 'block' : 'none';
            list.innerHTML = '';

            cloudFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div><b>${file.name}</b> <small>(Jucat: ${file.plays})</small></div>
                    <div>
                        <button class="btn-small" onclick="launchGameById('${file.id}')">â–¶ JoacÄƒ</button>
                        <button class="btn-small btn-delete" onclick="deleteQuiz('${file.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function deleteQuiz(id) {
            if (confirm("Sigur vrei sÄƒ È™tergi aceastÄƒ grilÄƒ definitiv din cloud?")) {
                const { error } = await _supabase.from('quizzes').delete().eq('id', id);
                if (!error) {
                    cloudFiles = cloudFiles.filter(f => f.id !== id);
                    renderHistory();
                }
            }
        }

        // [PÄƒstreazÄƒ funcÈ›iile handleFileUpload, parseQuestions È™i launchGame din codul anterior, adaptate la currentUser.id]
        
        window.onload = checkUser;
    </script>
</body>
</html>
